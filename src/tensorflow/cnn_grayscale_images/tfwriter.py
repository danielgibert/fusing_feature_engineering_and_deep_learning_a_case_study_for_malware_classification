import tensorflow as tf
import os
from pe_parser.hexadecimal_parser import HexParser
from pe_parser.utils import serialize_grayscale_image_example
import pandas as pd
from PIL import Image
import numpy as np


def microsoft_dataset_to_tfrecords(train_filepath,
                                   test_filepath,
                                   labels_filepath,
                                   tfrecords_filepath,
                                   width=128,
                                   height=128):

    training_tfwriter = tf.io.TFRecordWriter(tfrecords_filepath + "training.tfrecords")
    validation_tfwriter = tf.io.TFRecordWriter(tfrecords_filepath + "validation.tfrecords")
    test_tfwriter = tf.io.TFRecordWriter(tfrecords_filepath + "test.tfrecords")

    df_labels = pd.read_csv(labels_filepath)
    df_labels = df_labels.sample(frac=1).reset_index(drop=True)
    print(df_labels)
    total_samples = len(df_labels)
    training_samples= int((total_samples / 10) * 9)
    print(len(df_labels), training_samples)
    #Generate training and validation splits
    train_labels = df_labels[:9781]
    validation_labels = df_labels[9781:]
    print(train_labels, len(train_labels))
    print(validation_labels, len(validation_labels))




    j = 0
    for i in train_labels.index:
        print("{};{}".format(j, train_labels.loc[i, "Id"], train_labels.loc[i, "Class"]))
        hexParser = HexParser()
        hexParser.load_hexadecimal_file(train_filepath+train_labels.loc[i, "Id"]+".bytes")
        hexParser.extract_hex_values()
        grayscale_img = hexParser.convert_hex_values_to_img()

        # Downsample
        im = Image.fromarray(np.uint8(grayscale_img))
        im = im.resize((width, height), resample=Image.ANTIALIAS)
        raw_im = np.array(im.getdata(), dtype=np.float32)
        print(raw_im)


        example = serialize_grayscale_image_example(train_labels.loc[i, "Id"],
                                                    raw_im,
                                                    128,
                                                    128,
                                                    int(train_labels.loc[i, "Class"]) - 1)
        training_tfwriter.write(example)
        j += 1

    j = 0
    for i in validation_labels.index:
        print("{};{}".format(j, validation_labels.loc[i, "Id"], validation_labels.loc[i, "Class"]))
        hexParser = HexParser()
        hexParser.load_hexadecimal_file(train_filepath + validation_labels.loc[i, "Id"] + ".bytes")
        hexParser.extract_hex_values()
        grayscale_img = hexParser.convert_hex_values_to_img()

        # Downsample
        im = Image.fromarray(np.uint8(grayscale_img))
        im = im.resize((width, height), resample=Image.ANTIALIAS)
        raw_im = np.array(im.getdata(), dtype=np.float32)

        example = serialize_grayscale_image_example(validation_labels.loc[i, "Id"],
                                                    raw_im,
                                                    128,
                                                    128,
                                                    int(validation_labels.loc[i, "Class"]) - 1)
        validation_tfwriter.write(example)
        j += 1

    # Test set
    j = 0
    for filename in os.listdir(test_filepath):
        Id = filename[:-6]
        hexParser = HexParser()
        hexParser.load_hexadecimal_file(test_filepath + filename)
        hexParser.extract_hex_values()
        grayscale_img = hexParser.convert_hex_values_to_img()

        # Downsample
        im = Image.fromarray(np.uint8(grayscale_img))
        im = im.resize((width, height), resample=Image.ANTIALIAS)
        raw_im = np.array(im.getdata(), dtype=np.float32)

        example = serialize_grayscale_image_example(Id,
                                                    raw_im,
                                                    128,
                                                    128,
                                                    0)
        test_tfwriter.write(example)
        j += 1


trainLabels = "../../../data/feature_files/train/trainLabels.csv"
train_filepath = "/mnt/hdd1/cerberus_mlw_data/hexadecimal/train/"
test_filepath = "/mnt/hdd1/cerberus_mlw_data/hexadecimal/test/"
tfrecords_filepath = "/mnt/hdd1/cerberus_mlw_data/tfrecords/grayscale_images/"

microsoft_dataset_to_tfrecords(train_filepath, test_filepath, trainLabels, tfrecords_filepath, width=128, height=128)

