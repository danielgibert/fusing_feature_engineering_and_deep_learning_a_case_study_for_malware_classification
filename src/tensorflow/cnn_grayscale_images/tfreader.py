import tensorflow as tf


def _parse_tfrecord_function(example):
    example_fmt = {
            'Id': tf.io.FixedLenFeature([], tf.string),
            'img': tf.io.FixedLenFeature([], tf.string),
            'width': tf.io.FixedLenFeature([], tf.int64),
            'height': tf.io.FixedLenFeature([], tf.int64),
            'label': tf.io.FixedLenFeature([], tf.int64)
            }
    parsed = tf.io.parse_single_example(example, example_fmt)
    decoded_img = tf.io.decode_raw(parsed['img'], tf.float32)
    decoded_img = tf.reshape(decoded_img, (parsed['width'],
                                          parsed['height']))
    return parsed['Id'], decoded_img, parsed['label']



#"../../../data/tfrecords/training.tfrecords"
def make_dataset(filepath, SHUFFLE_BUFFER_SIZE=1024, BATCH_SIZE=32, EPOCHS=5):
    dataset = tf.data.TFRecordDataset(filepath)
    dataset = dataset.shuffle(SHUFFLE_BUFFER_SIZE)
    dataset = dataset.repeat(EPOCHS)
    dataset = dataset.map(lambda x: _parse_tfrecord_function(x))
    dataset = dataset.batch(batch_size=BATCH_SIZE)
    return dataset
