import pandas as pd
import argparse
import os

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('csv_filepath',
                        help="Filepath where all csv are located",
                        type=str)
    parser.add_argument('output_filepath',
                        help="Output csv filepath",
                        type=str)
    parser.add_argument("--exceptions",
                        nargs="+")
    parser.add_argument('--train', dest='train', action='store_true')
    parser.add_argument('--no-train', dest='train', action='store_false')
    parser.set_defaults(train=True)
    args = parser.parse_args()

    list_of_exceptions = args.exceptions
    print(list_of_exceptions)
    if list_of_exceptions is None:
        list_of_exceptions = []

    filenames = ["asm_api_features.csv",
                 "asm_cnn_opcode_features.csv",
                 "asm_data_define_features.csv",
                 "asm_metadata_features.csv",
                 "asm_misc_features.csv",
                 "asm_opcode_features.csv",
                 "asm_pixel_intensity_features.csv",
                 "asm_register_features.csv",
                 "asm_section_features.csv",
                 "asm_symbol_features.csv",
                 "byte_cnn_entropy_features.csv",
                 "byte_cnn_img_features.csv",
                 "byte_entropy_features.csv",
                 "byte_img_haralick_features.csv",
                 "byte_img_lbp_features.csv",
                 "byte_metadata_features.csv",
                 "byte_unigram_features.csv",
                 "bytes_cnn_features.csv"]

    start = 0
    for filename in filenames:
        if filename.endswith(".csv") and filename not in list_of_exceptions:
            if start == 0:
                df = pd.read_csv(args.csv_filepath+filename)
                df = df.sort_values(by=['Id'], ascending=False, ignore_index=True)
            else:
                df_ = pd.read_csv(args.csv_filepath+filename)
                if args.train is True:
                    df_ = df_.drop(columns=['Class'])

                df = df.merge(df_, on='Id')
            start += 1
    if "Unnamed: 0"  in list(df.columns):
        print("Found Unnamed: 0")
        df = df.drop(columns=["Unnamed: 0"])
    df.to_csv(args.output_filepath, header=True, index=False)


