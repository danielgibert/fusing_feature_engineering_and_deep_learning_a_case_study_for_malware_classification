import os
import csv
import argparse
from pe_parser.hexadecimal_parser import HexParser


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--train', dest='train', action='store_true')
    parser.add_argument('--no-train', dest='train', action='store_false')
    parser.set_defaults(train=True)
    args = parser.parse_args()

    if args.train == True:
        pe_filepath = "/mnt/hdd1/cerberus_mlw_data/hexadecimal/train/"
        output_filepath = "../../data/feature_files/train/byte_metadata_features.csv"
    else:
        pe_filepath = "/mnt/hdd1/cerberus_mlw_data/hexadecimal/test/"
        output_filepath = "../../data/feature_files/test/byte_metadata_features.csv"

    fieldnames = ['Id','BYTE_MD_FileSize', 'Byte_MD_FirstBytes']
    with open(output_filepath, "w") as output_file:
        writer = csv.DictWriter(output_file, fieldnames=fieldnames)
        writer.writeheader()
        i = 0
        filenames = os.listdir(pe_filepath)
        for filename in filenames:
            hex_parser = HexParser()
            print("{};{}".format(i,pe_filepath+filename))
            hex_parser.load_hexadecimal_file(pe_filepath+filename)
            metadata_features = hex_parser.extract_byte_metadata_features()
            metadata_features['Id'] = filename[:-6]
            writer.writerow({feature_name: metadata_features[feature_name] for feature_name in fieldnames})
            i+=1