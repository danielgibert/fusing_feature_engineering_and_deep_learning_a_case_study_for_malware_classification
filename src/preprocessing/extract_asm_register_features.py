import os
import csv
import argparse
from pe_parser.asm_parser import AssemblyParser


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--train', dest='train', action='store_true')
    parser.add_argument('--no-train', dest='train', action='store_false')
    parser.set_defaults(train=True)
    args = parser.parse_args()

    if args.train is True:
        pe_filepath = "/mnt/hdd1/cerberus_mlw_data/asm/raw/train/"
        output_filepath = "../../data/feature_files/train/asm_register_features.csv"
    else:
        pe_filepath = "/mnt/hdd1/cerberus_mlw_data/asm/raw/test/"
        output_filepath = "../../data/feature_files/test/asm_register_features.csv"

    fieldnames = ['Id','ASM_REG_rax', 'ASM_REG_eax', 'ASM_REG_ax', 'ASM_REG_ah', 'ASM_REG_al',
                  'ASM_REG_rcx', 'ASM_REG_ecx', 'ASM_REG_cx', 'ASM_REG_ch', 'ASM_REG_cl', 'ASM_REG_rdx',
                  'ASM_REG_edx', 'ASM_REG_dx', 'ASM_REG_dh', 'ASM_REG_dl', 'ASM_REG_rbx', 'ASM_REG_ebx',
                  'ASM_REG_bx', 'ASM_REG_bh', 'ASM_REG_bl', 'ASM_REG_rsp', 'ASM_REG_esp', 'ASM_REG_sp',
                  'ASM_REG_rbp', 'ASM_REG_ebp', 'ASM_REG_bp', 'ASM_REG_rsi', 'ASM_REG_esi', 'ASM_REG_si',
                  'ASM_REG_rdi', 'ASM_REG_edi', 'ASM_REG_di', 'ASM_REG_ss', 'ASM_REG_cs', 'ASM_REG_ds',
                  'ASM_REG_es', 'ASM_REG_fs', 'ASM_REG_gs']

    with open(output_filepath, "w") as output_file:
        writer = csv.DictWriter(output_file, fieldnames=fieldnames)
        writer.writeheader()
        i = 0
        filenames = os.listdir(pe_filepath)
        for filename in filenames:
            asm_parser = AssemblyParser()
            print("{};{}".format(i,pe_filepath+filename))
            asm_parser.load_asm_file(pe_filepath+filename)
            register_features = asm_parser.extract_register_features()
            register_features['Id'] = filename[:-4]
            writer.writerow({feature_name: register_features[feature_name] for feature_name in fieldnames})
            i+=1