import os
import csv
import argparse
from pe_parser.hexadecimal_parser import HexParser


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--train', dest='train', action='store_true')
    parser.add_argument('--no-train', dest='train', action='store_false')
    parser.set_defaults(train=True)
    args = parser.parse_args()

    if args.train is True:
        pe_filepath = "/mnt/hdd1/cerberus_mlw_data/hexadecimal/train/"
        output_filepath = "../../data/feature_files/train/byte_img_haralick_features.csv"
    else:
        pe_filepath = "/mnt/hdd1/cerberus_mlw_data/hexadecimal/test/"
        output_filepath = "../../data/feature_files/test/byte_img_haralick_features.csv"

    fieldnames = ['Id', 'BYTE_IMG_Haralick_f0', 'BYTE_IMG_Haralick_f1', 'BYTE_IMG_Haralick_f2', 'BYTE_IMG_Haralick_f3',
                  'BYTE_IMG_Haralick_f4', 'BYTE_IMG_Haralick_f5', 'BYTE_IMG_Haralick_f6', 'BYTE_IMG_Haralick_f7',
                  'BYTE_IMG_Haralick_f8', 'BYTE_IMG_Haralick_f9', 'BYTE_IMG_Haralick_f10', 'BYTE_IMG_Haralick_f11',
                  'BYTE_IMG_Haralick_f12', 'BYTE_IMG_Haralick_f13', 'BYTE_IMG_Haralick_f14', 'BYTE_IMG_Haralick_f15',
                  'BYTE_IMG_Haralick_f16', 'BYTE_IMG_Haralick_f17', 'BYTE_IMG_Haralick_f18', 'BYTE_IMG_Haralick_f19',
                  'BYTE_IMG_Haralick_f20', 'BYTE_IMG_Haralick_f21', 'BYTE_IMG_Haralick_f22', 'BYTE_IMG_Haralick_f23',
                  'BYTE_IMG_Haralick_f24', 'BYTE_IMG_Haralick_f25', 'BYTE_IMG_Haralick_f26', 'BYTE_IMG_Haralick_f27',
                  'BYTE_IMG_Haralick_f28', 'BYTE_IMG_Haralick_f29', 'BYTE_IMG_Haralick_f30', 'BYTE_IMG_Haralick_f31',
                  'BYTE_IMG_Haralick_f32', 'BYTE_IMG_Haralick_f33', 'BYTE_IMG_Haralick_f34', 'BYTE_IMG_Haralick_f35',
                  'BYTE_IMG_Haralick_f36', 'BYTE_IMG_Haralick_f37', 'BYTE_IMG_Haralick_f38', 'BYTE_IMG_Haralick_f39',
                  'BYTE_IMG_Haralick_f40', 'BYTE_IMG_Haralick_f41', 'BYTE_IMG_Haralick_f42', 'BYTE_IMG_Haralick_f43',
                  'BYTE_IMG_Haralick_f44', 'BYTE_IMG_Haralick_f45', 'BYTE_IMG_Haralick_f46', 'BYTE_IMG_Haralick_f47',
                  'BYTE_IMG_Haralick_f48', 'BYTE_IMG_Haralick_f49', 'BYTE_IMG_Haralick_f50', 'BYTE_IMG_Haralick_f51']



    with open(output_filepath, "w") as output_file:
        writer = csv.DictWriter(output_file, fieldnames=fieldnames)
        writer.writeheader()
        i = 0
        filenames = os.listdir(pe_filepath)
        for filename in filenames:
            hex_parser = HexParser()
            print("{};{}".format(i,pe_filepath+filename))
            hex_parser.load_hexadecimal_file(pe_filepath+filename)
            grayscale_img = hex_parser.convert_hex_values_to_img()
            byte_haralick_features = hex_parser.calculate_haralick_features(grayscale_img)
            byte_haralick_features['Id'] = filename[:-6]
            writer.writerow({feature_name: byte_haralick_features[feature_name] for feature_name in fieldnames})
            i+=1