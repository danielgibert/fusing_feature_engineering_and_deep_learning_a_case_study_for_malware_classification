import os
import csv
import argparse
from pe_parser.hexadecimal_parser import HexParser


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--train', dest='train', action='store_true')
    parser.add_argument('--no-train', dest='train', action='store_false')
    parser.set_defaults(train=True)
    args = parser.parse_args()

    if args.train is True:
        pe_filepath = "/mnt/hdd1/cerberus_mlw_data/hexadecimal/train/"
        output_filepath = "../../data/feature_files/train/byte_img_lbp_features.csv"
    else:
        pe_filepath = "/mnt/hdd1/cerberus_mlw_data/hexadecimal/test/"
        output_filepath = "../../data/feature_files/test/byte_img_lbp_features.csv"

    fieldnames = ['Id', 'BYTE_IMG_lbp_f0', 'BYTE_IMG_lbp_f1', 'BYTE_IMG_lbp_f2', 'BYTE_IMG_lbp_f3', 'BYTE_IMG_lbp_f4',
                  'BYTE_IMG_lbp_f5', 'BYTE_IMG_lbp_f6', 'BYTE_IMG_lbp_f7', 'BYTE_IMG_lbp_f8', 'BYTE_IMG_lbp_f9',
                  'BYTE_IMG_lbp_f10', 'BYTE_IMG_lbp_f11', 'BYTE_IMG_lbp_f12', 'BYTE_IMG_lbp_f13', 'BYTE_IMG_lbp_f14',
                  'BYTE_IMG_lbp_f15', 'BYTE_IMG_lbp_f16', 'BYTE_IMG_lbp_f17', 'BYTE_IMG_lbp_f18', 'BYTE_IMG_lbp_f19',
                  'BYTE_IMG_lbp_f20', 'BYTE_IMG_lbp_f21', 'BYTE_IMG_lbp_f22', 'BYTE_IMG_lbp_f23', 'BYTE_IMG_lbp_f24',
                  'BYTE_IMG_lbp_f25', 'BYTE_IMG_lbp_f26', 'BYTE_IMG_lbp_f27', 'BYTE_IMG_lbp_f28', 'BYTE_IMG_lbp_f29',
                  'BYTE_IMG_lbp_f30', 'BYTE_IMG_lbp_f31', 'BYTE_IMG_lbp_f32', 'BYTE_IMG_lbp_f33', 'BYTE_IMG_lbp_f34',
                  'BYTE_IMG_lbp_f35', 'BYTE_IMG_lbp_f36', 'BYTE_IMG_lbp_f37', 'BYTE_IMG_lbp_f38', 'BYTE_IMG_lbp_f39',
                  'BYTE_IMG_lbp_f40', 'BYTE_IMG_lbp_f41', 'BYTE_IMG_lbp_f42', 'BYTE_IMG_lbp_f43', 'BYTE_IMG_lbp_f44',
                  'BYTE_IMG_lbp_f45', 'BYTE_IMG_lbp_f46', 'BYTE_IMG_lbp_f47', 'BYTE_IMG_lbp_f48', 'BYTE_IMG_lbp_f49',
                  'BYTE_IMG_lbp_f50', 'BYTE_IMG_lbp_f51', 'BYTE_IMG_lbp_f52', 'BYTE_IMG_lbp_f53', 'BYTE_IMG_lbp_f54',
                  'BYTE_IMG_lbp_f55', 'BYTE_IMG_lbp_f56', 'BYTE_IMG_lbp_f57', 'BYTE_IMG_lbp_f58', 'BYTE_IMG_lbp_f59',
                  'BYTE_IMG_lbp_f60', 'BYTE_IMG_lbp_f61', 'BYTE_IMG_lbp_f62', 'BYTE_IMG_lbp_f63', 'BYTE_IMG_lbp_f64',
                  'BYTE_IMG_lbp_f65', 'BYTE_IMG_lbp_f66', 'BYTE_IMG_lbp_f67', 'BYTE_IMG_lbp_f68', 'BYTE_IMG_lbp_f69',
                  'BYTE_IMG_lbp_f70', 'BYTE_IMG_lbp_f71', 'BYTE_IMG_lbp_f72', 'BYTE_IMG_lbp_f73', 'BYTE_IMG_lbp_f74',
                  'BYTE_IMG_lbp_f75', 'BYTE_IMG_lbp_f76', 'BYTE_IMG_lbp_f77', 'BYTE_IMG_lbp_f78', 'BYTE_IMG_lbp_f79',
                  'BYTE_IMG_lbp_f80', 'BYTE_IMG_lbp_f81', 'BYTE_IMG_lbp_f82', 'BYTE_IMG_lbp_f83', 'BYTE_IMG_lbp_f84',
                  'BYTE_IMG_lbp_f85', 'BYTE_IMG_lbp_f86', 'BYTE_IMG_lbp_f87', 'BYTE_IMG_lbp_f88', 'BYTE_IMG_lbp_f89',
                  'BYTE_IMG_lbp_f90', 'BYTE_IMG_lbp_f91', 'BYTE_IMG_lbp_f92', 'BYTE_IMG_lbp_f93', 'BYTE_IMG_lbp_f94',
                  'BYTE_IMG_lbp_f95', 'BYTE_IMG_lbp_f96', 'BYTE_IMG_lbp_f97', 'BYTE_IMG_lbp_f98', 'BYTE_IMG_lbp_f99',
                  'BYTE_IMG_lbp_f100', 'BYTE_IMG_lbp_f101', 'BYTE_IMG_lbp_f102', 'BYTE_IMG_lbp_f103',
                  'BYTE_IMG_lbp_f104', 'BYTE_IMG_lbp_f105', 'BYTE_IMG_lbp_f106', 'BYTE_IMG_lbp_f107']

    with open(output_filepath, "w") as output_file:
        writer = csv.DictWriter(output_file, fieldnames=fieldnames)
        writer.writeheader()
        i = 0
        filenames = os.listdir(pe_filepath)
        for filename in filenames:
            hex_parser = HexParser()
            print("{};{}".format(i,pe_filepath+filename))
            hex_parser.load_hexadecimal_file(pe_filepath+filename)
            grayscale_img = hex_parser.convert_hex_values_to_img()
            byte_lbp_features = hex_parser.calculate_LBP_features(grayscale_img)
            byte_lbp_features['Id'] = filename[:-6]
            writer.writerow({feature_name: byte_lbp_features[feature_name] for feature_name in fieldnames})
            i+=1